<VirtualHost localhost:5000>
    # enable SSL
    SSLEngine on

    # for security reasons you may restrict the SSL protocol, but some clients may fail if SSLv2 is not supported
    SSLProtocol all -SSLv2 -SSLv3

    # this should point to your server host certificate
    SSLCertificateFile /etc/grid-security/keystorm-cert.pem

    # this should point to your server host key
    SSLCertificateKeyFile /etc/grid-security/keystorm-key.pem

    # directory containing the Root CA certificates and their hashes
    SSLCACertificatePath /etc/grid-security/certificates

    # directory containing CRLs
    SSLCARevocationPath /etc/grid-security/certificates

    LogLevel info
    ErrorLog /var/log/apache/keystorm-error.log
    CustomLog /var/log/apache/keystorm-access.log common

    ServerName localhost

    # if you have multiple CAs in the file above, you may need to increase the verify depht
    SSLVerifyDepth 10

    # set to optional, this tells Apache to attempt to verify SSL certificates if provided
    # for X.509 access with GridSite/VOMS, however, set to 'require'
    SSLVerifyClient optional

    # enable passing of SSL variables to passenger. For GridSite/VOMS, enable also exporting certificate data
    SSLOptions +StdEnvVars +ExportCertData +LegacyDNStringFormat

    RequestHeader set X_FORWARDED_PROTO 'https'
    RemoteIPHeader X-Forwarded-For

    ProxyPreserveHost On
    ProxyPass / http://keystorm:3000/
    ProxyPassReverse / http://keystorm:3000/

    RequestHeader set GRST_VOMS_FQANS ""
    RequestHeader set GRST_CRED_0 ""
    RequestHeader set GRST_CRED_1 ""
    RequestHeader set GRST_CRED_2 ""
    RequestHeader set GRST_CRED_3 ""
    RequestHeader set GRST_CRED_4 ""
    RequestHeader set GRST_CRED_5 ""
    RequestHeader set GRST_CRED_6 ""
    RequestHeader set GRST_CRED_7 ""
    RequestHeader set GRST_CRED_8 ""
    RequestHeader set GRST_CRED_9 ""
    RequestHeader set GRST_CRED_10 ""
    RequestHeader set SSL_CLIENT_I_DN ""
    RequestHeader set SSL_CLIENT_S_DN ""
    RequestHeader set SSL_CLIENT_VERIFY ""

    OIDCResponseType "code"
    OIDCClaimPrefix "OIDC-"
    OIDCClaimDelimiter ;
    OIDCScope "openid"
    OIDCProviderMetadataURL [oidc-provider-metadata-url]
    OIDCClientID [oidc-client-id]
    OIDCClientSecret [oidc-client-secret]
    OIDCCryptoPassphrase [oidc-crypto-passphrase]
    OIDCRedirectURI [oidc-redirect-uri]

    # OAuth for CLI access
    OIDCOAuthIntrospectionEndpoint [oidc-auth-introspection-endpoint]
    OIDCOAuthClientID [oidc-auth-client-id]
    OIDCOAuthClientSecret [oidc-auth-client-secret]

    <Location /v3/OS-FEDERATION/identity_providers/egi.eu/protocols/mapped/auth>
        #for GridSite/VOMS enable the four directives in the following block:
        #  ## variables (and is needed for gridsite-admin.cgi to work.)
        GridSiteEnvs on
        #  ## Nice GridSite directory listings (without truncating file names!)
        GridSiteIndexes off
        #  ## If this is greater than zero, we will accept GSI Proxies for clients
        #  ## (full client certificates - eg inside web browsers - are always ok)
        GridSiteGSIProxyLimit 4
        #  ## This directive allows authorized people to write/delete files
        #  ## from non-browser clients - eg with htcp(1)
        GridSiteMethods ""

        Require all granted
        Options -MultiViews

        RequestHeader set GRST_VOMS_FQANS "%{GRST_VOMS_FQANS}e"
        RequestHeader set GRST_CRED_0 "%{GRST_CRED_0}e"
        RequestHeader set GRST_CRED_1 "%{GRST_CRED_1}e"
        RequestHeader set GRST_CRED_2 "%{GRST_CRED_2}e"
        RequestHeader set GRST_CRED_3 "%{GRST_CRED_3}e"
        RequestHeader set GRST_CRED_4 "%{GRST_CRED_4}e"
        RequestHeader set GRST_CRED_5 "%{GRST_CRED_5}e"
        RequestHeader set GRST_CRED_6 "%{GRST_CRED_6}e"
        RequestHeader set GRST_CRED_7 "%{GRST_CRED_7}e"
        RequestHeader set GRST_CRED_8 "%{GRST_CRED_8}e"
        RequestHeader set GRST_CRED_9 "%{GRST_CRED_9}e"
        RequestHeader set GRST_CRED_10 "%{GRST_CRED_10}e"
        RequestHeader set SSL_CLIENT_I_DN "%{SSL_CLIENT_I_DN}s"
        RequestHeader set SSL_CLIENT_S_DN "%{SSL_CLIENT_S_DN}s"
        RequestHeader set SSL_CLIENT_VERIFY "%{SSL_CLIENT_VERIFY}s"

        ProxyPass http://keystorm:3000/v3/auth/federation/voms/
        ProxyPassReverse http://keystorm:3000/v3/auth/federation/voms/
    </Location>

    <Location /v3/OS-FEDERATION/identity_providers/egi.eu/protocols/oidc/auth>
        Authtype oauth20
        Require  valid-user
        Options  -MultiViews

        ProxyPass http://keystorm:3000/v3/auth/federation/oidc/
        ProxyPassReverse http://keystorm:3000/v3/auth/federation/oidc/
    </Location>

    <Location [oidc-redirect-uri]>
        Authtype openid-connect
        Require  valid-user
    </Location>
</VirtualHost>
